import datetime
import unittest

from trigger2bit import augment_with_collision_trigger_class


run_dict = {'C0LSR-ABCE-NOPF-CENTNOTRD': 100L,
            'C0TVX-A-NOPF-CENTNOTRD': 0L,
            'C0TVX-B-NOPF-CENT': 360778L,
            'C0TVX-B-NOPF-CENTNOTRD': 0L,
            'C0TVX-C-NOPF-CENTNOTRD': 0L,
            'C0TVX-E-NOPF-CENTNOTRD': 0L,
            'C0UBA-A-NOPF-CENTNOTRD': 0L,
            'C0UBA-B-NOPF-CENTNOTRD': 623311L,
            'C0UBA-C-NOPF-CENTNOTRD': 0L,
            'C0UBA-E-NOPF-CENTNOTRD': 0L,
            'C0UBC-A-NOPF-CENTNOTRD': 0L,
            'C0UBC-B-NOPF-CENTNOTRD': 691984L,
            'C0UBC-C-NOPF-CENTNOTRD': 0L,
            'C0UBC-E-NOPF-CENTNOTRD': 0L,
            'C0V0M-A-NOPF-CENTNOTRD': 0L,
            'C0V0M-B-NOPF-CENTNOTRD': 76L,
            'C0V0M-C-NOPF-CENTNOTRD': 0L,
            'C0V0M-E-NOPF-CENTNOTRD': 0L,
            'CADAND-A-NOPF-CENTNOTRD': 0L,
            'CADAND-B-NOPF-CENTNOTRD': 0L,
            'CADAND-C-NOPF-CENTNOTRD': 0L,
            'CADAND-E-NOPF-CENTNOTRD': 0L,
            'CINT5-A-NOPF-CENTNOTRD': 0L,
            'CINT5-B-NOPF-CENT': 723302L,
            'CINT5-B-NOPF-CENTNOTRD': 723300L,
            'CINT5-C-NOPF-CENTNOTRD': 0L,
            'CINT5-E-NOPF-CENTNOTRD': 0L,
            'CINT7-A-NOPF-CENTNOTRD': 16L,
            'CINT7-B-NOPF-CENT': 637227L,
            'CINT7-B-NOPF-CENTNOTRD': 637225L,
            'CINT7-B-NOPF-MUON': 6722L,
            'CINT7-C-NOPF-CENTNOTRD': 53L,
            'CINT7-E-NOPF-CENTNOTRD': 0L,
            'CMLL7-A-NOPF-MUON': 0L,
            'CMLL7-B-NOPF-MUON': 7321L,
            'CMLL7-C-NOPF-MUON': 0L,
            'CMLL7-E-NOPF-MUON': 0L,
            'CMSH7-A-NOPF-MUFAST': 0L,
            'CMSH7-B-NOPF-MUFAST': 49999L,
            'CMSH7-C-NOPF-MUFAST': 0L,
            'CMSH7-E-NOPF-MUFAST': 0L,
            'CMSL7-A-NOPF-MUON': 0L,
            'CMSL7-B-NOPF-MUON': 161084L,
            'CMSL7-C-NOPF-MUON': 0L,
            'CMSL7-E-NOPF-MUON': 0L,
            'CMUL7-A-NOPF-MUFAST': 0L,
            'CMUL7-B-NOPF-MUFAST': 9931L,
            'CMUL7-B-NOPF-MUON': 8785L,
            'CMUL7-C-NOPF-MUFAST': 0L,
            'CMUL7-E-NOPF-MUFAST': 0L,
            'CTEST52-A-NOPF-CENTNOTRD': 0L,
            'CTEST52-B-NOPF-CENTNOTRD': 0L,
            'CTEST52-C-NOPF-CENTNOTRD': 0L,
            'CTEST52-E-NOPF-CENTNOTRD': 0L,
            'CTRUE-A-NOPF-CENTNOTRD': 721L,
            'CTRUE-B-NOPF-CENTNOTRD': 3958L,
            'CTRUE-C-NOPF-CENTNOTRD': 1083L,
            'CTRUE-E-NOPF-CENTNOTRD': 1300L,
            'DAQ_time_end': 1436381660.0,
            'DAQ_time_start': 1436380241.0,
            'Dipole_magnetCurrent': 6000.0,
            'GDClocalRecording': 0L,
            'GDCmStreamRecording': 1L,
            'HLTmode': 'A',
            'L2a': 1395312L,
            'L3_magnetCurrent': 30000.0,
            'LDClocalRecording': 0L,
            'LHCBeamMode': 'STABLE BEAMS',
            'LHCBetaStar': 10.21,
            'LHCFillNumber': 3976L,
            'LHCFillingSchemeName': '50ns_152b_110_36_108_36bpi7inj',
            'LHCInfoStatus': 'validated',
            'LHCInstIntensityInteractingBeam1Avg': 3723660000000.0,
            'LHCInstIntensityInteractingBeam1EOR': 3703280000000.0,
            'LHCInstIntensityInteractingBeam1SOR': 3745860000000.0,
            'LHCInstIntensityInteractingBeam2Avg': 3950270000000.0,
            'LHCInstIntensityInteractingBeam2EOR': 3949170000000.0,
            'LHCInstIntensityInteractingBeam2SOR': 3951410000000.0,
            'LHCInstIntensityNonInteractingBeam1Avg': 12274000000000.0,
            'LHCInstIntensityNonInteractingBeam1EOR': 12249900000000.0,
            'LHCInstIntensityNonInteractingBeam1SOR': 12299100000000.0,
            'LHCInstIntensityNonInteractingBeam2Avg': 11703300000000.0,
            'LHCInstIntensityNonInteractingBeam2EOR': 11674400000000.0,
            'LHCInstIntensityNonInteractingBeam2SOR': 11732100000000.0,
            'LHCTotalInteractingBunches': 36L,
            'LHCTotalNonInteractingBunchesBeam1': 116L,
            'LHCTotalNonInteractingBunchesBeam2': 116L,
            'LHCperiod': 'LHC15g',
            'TRGTimeEnd': 1436381468.0,
            'TRGTimeStart': 1436380250.0,
            'activeDetectors': 'ITSSPD ITSSDD ITSSSD TPC TOF HMPID FMD T0 VZERO ACORDE AD MUONTRK MUONTRG',
            'averageDataRateEventBuilder': 3053351013.5,
            'averageDataRateReadout': 3290714722.1,
            'averageDataRateRecorded': 2119346378.0,
            'averageEventsPerSecond': 637.47004933,
            'averageSubEventsPerSecond': 0.0,
            'bcs': 36,
            'beamEnergy': 6500.0,
            'beamType': 'p-p',
            'calibration': 0,
            'ctpDuration': 1219.31,
            'daq_success': 0L,
            'dataMigrated': 'Yes',
            'detector': '',
            'detectorMask': 2325615L,
            'ecs_iteration_current': 0L,
            'ecs_iteration_total': 0L,
            'ecs_success': 1L,
            'eor_reason': 'Operator_Request',
            'eventBuilding': 1L,
            'fill': 3976,
            'forceLHCReco': '0',
            'interactionRate': 143764.96779604896,
            'lhcPeriod': 'LHC15g',
            'lhcState': 'STABLE BEAMS',
            'log': '',
            'lumi_seen': 2332.826210770555,
            'mu': 0.3551330660442888,
            'numberOfDetectors': 13L,
            'numberOfFailedPar': 0,
            'numberOfGDCs': 10L,
            'numberOfLDCs': 147L,
            'numberOfPar': 1,
            'numberOfStreams': 0L,
            'partition': 'PHYSICS_1',
            'pauseDuration': 10,
            'refCounts': 65241249.0,
            'run': 229376,
            'runDuration': 1419,
            'runQuality': 'Good run',
            'run_duration': 1217.0,
            'run_type': 'PHYSICS',
            'splitterDetectorMask': 0L,
            'timeEnd': datetime.datetime(2015, 7, 8, 20, 54, 20),
            'timeStart': datetime.datetime(2015, 7, 8, 20, 30, 41),
            'time_completed': 1436381660.0,
            'time_created': 1436380190.0,
            'time_update': '2015-12-04 09:53:31',
            'totalDataEventBuilder': 4332705088200.0,
            'totalDataReadout': 4669524190696.0,
            'totalDataRecorded': 3007352510416.0,
            'totalEvents': 904570L,
            'totalEventsCalibration': 5188,
            'totalEventsIncomplete': 1313,
            'totalEventsPhysics': 898794,
            'totalNumberOfFilesClosed': 0,
            'totalNumberOfFilesMigrated': 1857,
            'totalNumberOfFilesMigrating': 0,
            'totalNumberOfFilesMigrationRequested': 0,
            'totalNumberOfFilesWaitingMigration': 0,
            'totalNumberOfFilesWriting': 0,
            'totalSubEvents': 0L}


class Test_trigger_alias(unittest.TestCase):
    def test_good_run_pp(self):
        mini_dict = {'run': 244824, 'lhcState': 'STABLE BEAM'}
        augment_with_collision_trigger_class(mini_dict)
        self.assertIn("VEventBit0", mini_dict.keys())

    def test_bad_run_pp(self):
        mini_dict = {'run': 999999999, 'lhcState': 'STABLE BEAM',
                     'beamType': 'p-p'}
        augment_with_collision_trigger_class(mini_dict)
        self.assertIn("VEventBit0", mini_dict.keys())

    def test_bad_run_no_beam_type(self):
        mini_dict = {'run': 999999999, 'lhcState': 'STABLE BEAM'}
        self.assertRaises(KeyError, augment_with_collision_trigger_class, mini_dict)
